// Prisma Schema - Veritabanı Modelleri
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  title     String?
  roleId    String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role      Role     @relation(fields: [roleId], references: [id])
  projects  Project[]
  transactions Transaction[]
  documents Document[]

  @@index([email])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  permissions Json     @default("[]") // PostgreSQL JSON desteği
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

model Company {
  id           String   @id @default(cuid())
  name         String   @unique
  taxNumber    String   @unique
  baseCurrency String   // Currency enum
  address      String?
  phone        String?
  email        String?
  website      String?
  logoColor    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects     Project[]
  contracts    Contract[]
  bankBranches  BankBranch[]
  bankAccounts  BankAccount[]
  bankCards     BankCard[]
  invoices     Invoice[]
}

model Entity {
  id        String   @id @default(cuid())
  name      String
  type      String   // EntityType enum
  taxOffice String?
  taxNumber String?
  email     String?
  phone     String?
  address   String?
  iban      String?
  bankName  String?
  status    String   @default("active") // "active" | "passive"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
  contracts Contract[]
  transactions Transaction[]
  invoices Invoice[]

  @@index([type, status])
}

model Project {
  id                String   @id @default(cuid())
  code              String   @unique
  name              String
  description       String?
  companyId         String
  customerId        String?
  managerId         String?
  agreementCurrency String   // Currency enum
  budget            Float    @default(0)
  startDate         DateTime
  endDate           DateTime?
  status            String   @default("active") // ProjectStatus enum
  priority          String   @default("medium") // ProjectPriority enum
  location          String?
  tags              Json     @default("[]") // PostgreSQL JSON desteği
  progress          Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company   Company   @relation(fields: [companyId], references: [id])
  customer  Entity?   @relation(fields: [customerId], references: [id])
  manager   User?     @relation(fields: [managerId], references: [id])
  contracts Contract[]
  transactions Transaction[]
  documents Document[]
  invoices Invoice[]

  @@index([companyId, status])
}

model Contract {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  type        String   // ContractType enum
  status      String   @default("draft") // ContractStatus enum
  projectId   String
  companyId   String
  entityId    String
  startDate   DateTime
  endDate     DateTime
  amount      Float    @default(0) // KDV hariç tutar
  currency    String   // Currency enum
  paymentTerms String?
  description String?
  attachments Json     @default("[]") // PostgreSQL JSON desteği
  documentUrl String?  // Sözleşme PDF'i
  isVatIncluded Boolean @default(false) // KDV dahil mi? (Varsayılan: KDV hariç)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id])
  company     Company      @relation(fields: [companyId], references: [id])
  entity      Entity       @relation(fields: [entityId], references: [id])
  transactions Transaction[]
  invoices    Invoice[]

  @@index([projectId, status])
}

model Transaction {
  id            String   @id @default(cuid())
  projectId     String
  type          String   // "income" | "expense"
  amount        Float    // KDV hariç tutar
  currency      String   // Currency enum
  exchangeRate  Float
  date          DateTime
  description   String
  category      String
  invoiceNumber String?
  contractId    String?
  taxes         Json?    // PostgreSQL JSON desteği
  totalAmount   Float?
  documentUrl   String?
  isVatIncluded Boolean  @default(false) // KDV dahil mi?
  isAutoGenerated Boolean @default(false) // Ödemeden otomatik oluşturuldu mu?
  bankAccountId String?
  bankCardId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id])
  contract    Contract?    @relation(fields: [contractId], references: [id])
  entity      Entity?      @relation(fields: [entityId], references: [id])
  uploader    User         @relation(fields: [uploaderId], references: [id])
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  bankCard    BankCard?    @relation(fields: [bankCardId], references: [id], onDelete: SetNull)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payment     Payment?     // Ters ilişki - bu transaction'ı oluşturan payment

  entityId    String?
  uploaderId  String
  invoiceId   String?

  @@index([projectId, date])
  @@index([contractId])
  @@index([bankAccountId])
  @@index([bankCardId])
  @@index([invoiceId])
  @@index([isAutoGenerated])
}

model Document {
  id        String   @id @default(cuid())
  name      String
  type      String   // "pdf" | "image" | "spreadsheet" | "word" | "other"
  size      String
  uploadDate DateTime @default(now())
  uploaderId String
  category  String   // "contract" | "invoice" | "project" | "personnel" | "general"
  relatedId String?  // Proje, Sözleşme veya Personel ID'si
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  uploader User @relation(fields: [uploaderId], references: [id])
  project  Project? @relation(fields: [relatedId], references: [id])

  @@index([category, relatedId])
}

model Tax {
  id              String   @id @default(cuid())
  name            String   @unique
  code            String?  // Vergi kodu (örn: KDV, Stopaj, Tevkifat)
  rate            Float    // Oran (% veya sabit tutar)
  calculationType String   @default("percentage") // "percentage" | "fixed"
  baseType        String   @default("amount") // "amount" | "vat" | "total" - Hesaplama tabanı
  description     String?
  isActive        Boolean  @default(true)
  order           Int      @default(0) // Sıralama
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive, order])
}

model BankBranch {
  id          String   @id @default(cuid())
  name        String
  code        String?  // Şube kodu
  address     String?
  phone       String?
  email       String?
  city        String?
  district    String?
  companyId   String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankAccounts BankAccount[]

  @@index([companyId, isActive])
}

model BankAccount {
  id            String   @id @default(cuid())
  accountName   String   // Hesap adı
  accountNumber String   // Hesap numarası
  iban          String?  // IBAN
  currency      String   @default("TRY") // Currency enum
  accountType   String   @default("checking") // "checking" | "savings" | "deposit" | "foreign"
  bankName      String
  branchId      String?
  companyId     String
  balance       Float    @default(0)
  isActive      Boolean  @default(true)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  branch        BankBranch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  bankCards     BankCard[]
  transactions  Transaction[]
  payments      Payment[]

  @@index([companyId, isActive])
  @@index([branchId])
}

model BankCard {
  id            String   @id @default(cuid())
  cardName      String   // Kart adı
  cardNumber    String?  // Son 4 hanesi (güvenlik için)
  cardType      String   @default("credit") // "credit" | "debit" | "prepaid"
  bankName      String
  accountId     String?
  companyId     String
  expiryDate    DateTime?
  limit         Float?   // Kredi kartı limiti
  isActive      Boolean  @default(true)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  account       BankAccount? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  transactions  Transaction[]
  payments      Payment[]

  @@index([companyId, isActive])
  @@index([accountId])
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique // Fatura numarası
  invoiceType   String   @default("outgoing") // "incoming" | "outgoing" - Gelen/Giden
  invoiceDate   DateTime // Fatura tarihi
  dueDate       DateTime? // Vade tarihi
  amount        Float    @default(0) // KDV hariç tutar
  vatAmount     Float    @default(0) // KDV tutarı
  totalAmount   Float    @default(0) // Toplam tutar
  currency      String   @default("TRY") // Currency enum
  status        String   @default("draft") // "draft" | "issued" | "paid" | "cancelled" | "overdue"
  projectId     String?
  companyId     String
  entityId      String   // Müşteri/Tedarikçi
  contractId    String?   // Bağlı sözleşme
  description   String?
  documentUrl   String?  // Fatura PDF'i
  isVatIncluded Boolean  @default(false) // KDV dahil mi?
  taxes         Json?    // PostgreSQL JSON desteği - Dinamik vergiler
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entity    Entity     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  contract  Contract?  @relation(fields: [contractId], references: [id], onDelete: SetNull)
  payments  Payment[]
  transactions Transaction[]

  @@index([companyId, status])
  @@index([projectId])
  @@index([entityId])
  @@index([invoiceDate])
  @@index([dueDate])
}

model Payment {
  id            String   @id @default(cuid())
  paymentType   String   @default("outgoing") // "incoming" (gelen ödeme - bize ödeniyor) | "outgoing" (giden ödeme - biz ödüyoruz)
  paymentDate   DateTime // Ödeme tarihi
  amount        Float    // Ödeme tutarı
  currency      String   @default("TRY") // Currency enum
  exchangeRate  Float    @default(1) // Döviz kuru (proje para birimine çevrim için)
  paymentMethod String   @default("transfer") // "cash" | "transfer" | "card" | "check"
  invoiceId     String?  // Bağlı fatura
  bankAccountId String?  // Ödeme yapılan hesap
  bankCardId    String?  // Ödeme yapılan kart
  transactionId String?  @unique // Otomatik oluşturulan Transaction
  description   String?
  referenceNumber String? // Referans numarası (dekont no, çek no vb.)
  status        String   @default("completed") // "pending" | "completed" | "failed" | "cancelled"
  documentUrl   String?  // Ödeme belgesi (dekont, makbuz)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  bankAccount  BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  bankCard     BankCard?    @relation(fields: [bankCardId], references: [id], onDelete: SetNull)
  transaction  Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
  @@index([paymentType])
  @@index([transactionId])
}

